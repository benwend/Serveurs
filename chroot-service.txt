#############################################
#											#
#		CLOISSEMENT D'UN SERVICE			#
#											#
#		  à l'aide de Makejail				#
#											#
#############################################

#####
## INFOS
# Date : 20/10/2013
# Moyen : makejail, isolement/cloissement d'un service dans un chroot


## Documentation :
	Magazine MISC HS n°4 : Sécurité côté serveur. Christophe Bailleux
	http://www.floc.net/makejail/current/doc/
	http://bibabox.fr/apache2-mpm-itk-utiliser-un-utiliser-un-utilisateur-different-pour-chaque-vhost/
	/usr/share/doc/makejail/
	

## Résumé :
	Sécurisation du serveur en cloissonant les services sensibles (BD / www / Proxy...), à l'aide de makejail, script python.
	L'application va rechercher tous les processus utiliser par le service puis l'isoler dans un chroot.

## Etapes :
1)	Installation d'Apache2 MPM ITK et de PHP5 :
		# apt-get install apache2-mpm-itk php5
		(apache2-mpm-itk apache2-utils apache2.2-bin apache2.2-common libapache2-mod-php5 libapr1 libaprutil1 libaprutil1-dbd-sqlite3 libaprutil1-ldap libonig2 libqdbm14 php5 php5-cli php5-common php5-suhosin ssl-cert)

2)	Installation du script Python "MakeJail"
		# apt-get install makejail

3) Installation aussi de programmes pour les tests :
		# apt-get install lynx wget

4)	Personnalisation du confinement du processus à l'aide d'un fichier de configuration :
		# nano /etc/makejail/apache2

5)	Lancement du script avec le fichier de configuration comme paramètre :
		# makejail /etc/makejail/apache2

6)	Une erreur apparait :
		Executing : file /usr/lib/apache2/modules/hhtpd.exp
		/usr/lib/apache2/modules/httpd.exp is a script run with the interpreter.
		 Checking path '.'
		ERROR: The path '.' is not absolute
	Ne pas en tenir commpte et relancer le script
		# makejail /etc/makejail/apache2

7)	Installation en environnement confiné :
		# ls /chroot/apache2
		/bin /dev /etc ...

8)	Test de la bonne exécution d'Apache2 :
		# chroot /chroot/apache2/ /usr/sbin/apache2ctl start
		# ps aux | egrep apache2
		...

9)	Tout ce qui sera en relation avec la configuration, etc, devra être installé dans le répertoire " /chroot/apache2 ".